{% comment %}
templates/tasks/partials/comment_form.html
Sub-Phase 11C: Enhanced HTMX Comment Form

Features:
- HTMX form that appends new comment to list (beforeend swap)
- Form resets after successful submission
- Cmd/Ctrl+Enter keyboard shortcut to submit
- User avatar with initials
- Loading indicator inside textarea area
- Focus returns to input after submission

Context variables required:
- task: Task instance
- request.user: Current user (for avatar)
- can_comment: Boolean - whether user can add comments (optional, defaults to True)

Usage:
{% include 'tasks/partials/comment_form.html' with task=task %}
{% endcomment %}

{% if can_comment|default:True %}
<div class="border-t border-gray-200 pt-4" id="comment-form-container">
    <form method="post" 
          action="{% url 'tasks:add_comment' task.pk %}"
          hx-post="{% url 'tasks:add_comment' task.pk %}"
          hx-target="#comments-list"
          hx-swap="beforeend"
          hx-indicator="#comment-form-loading"
          hx-on::after-request="
              if(event.detail.successful) { 
                  this.reset(); 
                  const noComments = document.getElementById('no-comments'); 
                  if(noComments) noComments.remove();
                  document.getElementById('id_content').focus();
                  const countEl = document.getElementById('comment-count');
                  if(countEl) {
                      const current = parseInt(countEl.textContent) || 0;
                      countEl.textContent = current + 1;
                  }
              }
          "
          class="relative"
          x-data="{ 
              content: '',
              submitting: false,
              handleKeydown(e) {
                  // Cmd+Enter (Mac) or Ctrl+Enter (Windows/Linux) to submit
                  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                      e.preventDefault();
                      if (this.content.trim()) {
                          this.$el.closest('form').requestSubmit();
                      }
                  }
              }
          }">
        {% csrf_token %}
        
        <div class="flex space-x-3">
            {# User Avatar #}
            <div class="flex-shrink-0">
                <div class="h-10 w-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-sm">
                    <span class="text-white text-sm font-medium">
                        {{ request.user.first_name|slice:":1"|upper }}{{ request.user.last_name|slice:":1"|upper }}
                    </span>
                </div>
            </div>
            
            {# Input Area #}
            <div class="flex-1 min-w-0">
                <div class="relative">
                    {# Textarea with keyboard shortcut support #}
                    <textarea 
                        name="content" 
                        id="id_content"
                        rows="3"
                        x-model="content"
                        @keydown="handleKeydown"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm resize-none transition-colors duration-150 pr-12"
                        placeholder="Add a comment... (Ctrl+Enter to submit)"
                        required
                        :disabled="submitting"></textarea>
                    
                    {# Loading Indicator - Overlay on textarea #}
                    <div id="comment-form-loading" 
                         class="htmx-indicator absolute inset-0 bg-white/80 rounded-lg flex items-center justify-center">
                        <div class="flex items-center space-x-2 text-indigo-600">
                            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-sm font-medium">Posting...</span>
                        </div>
                    </div>
                    
                    {# Character count hint (optional visual) #}
                    <div class="absolute bottom-2 right-2 text-xs text-gray-400 pointer-events-none"
                         x-show="content.length > 0"
                         x-text="content.length + ' chars'">
                    </div>
                </div>
                
                {# Action Row #}
                <div class="mt-3 flex items-center justify-between">
                    {# Keyboard Shortcut Hint #}
                    <div class="text-xs text-gray-400 hidden sm:flex items-center space-x-1">
                        <kbd class="px-1.5 py-0.5 bg-gray-100 border border-gray-300 rounded text-gray-600 font-mono text-xs">
                            {% if request.META.HTTP_USER_AGENT|default:""|lower|slice:":3" == "mac" %}⌘{% else %}Ctrl{% endif %}
                        </kbd>
                        <span>+</span>
                        <kbd class="px-1.5 py-0.5 bg-gray-100 border border-gray-300 rounded text-gray-600 font-mono text-xs">↵</kbd>
                        <span class="ml-1">to submit</span>
                    </div>
                    
                    {# Submit Button #}
                    <button type="submit" 
                            :disabled="!content.trim()"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-indigo-600">
                        <svg class="h-4 w-4 mr-1.5 -ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        Add Comment
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

{% elif task.status == 'cancelled' %}
<div class="border-t border-gray-200 pt-4">
    <div class="flex items-center justify-center py-4 text-gray-500 bg-gray-50 rounded-lg">
        <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
        </svg>
        <span class="text-sm italic">Comments are disabled for cancelled tasks.</span>
    </div>
</div>

{% else %}
<div class="border-t border-gray-200 pt-4">
    <div class="flex items-center justify-center py-4 text-gray-500 bg-gray-50 rounded-lg">
        <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
        <span class="text-sm italic">You don't have permission to comment on this task.</span>
    </div>
</div>
{% endif %}