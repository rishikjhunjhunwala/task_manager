{% comment %}
Attachment section partial for task detail view.

Context variables required:
- task: Task instance
- attachment: Attachment instance (or None)
- attachment_form: AttachmentForm instance
- can_attachment: Boolean - whether user can add/replace attachments
- can_remove: Boolean - whether user can remove the attachment

HTMX Behavior:
- Upload form submits via HTMX POST to upload_attachment endpoint
- After upload, this entire section is swapped with updated content
- Remove button triggers HTMX POST with confirmation dialog
- All actions target #attachment-section for swap

File Icons:
- PDF: Red document icon
- DOC/DOCX: Blue document icon  
- XLS/XLSX: Green document icon
- Images (PNG/JPG/JPEG): Purple image icon
- TXT: Gray document icon
- Default: Gray generic file icon
{% endcomment %}

<div id="attachment-section" class="bg-white shadow sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <!-- Section Header -->
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <svg class="inline-block h-5 w-5 text-gray-400 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
            </svg>
            Attachment
        </h3>

        {% if attachment %}
        <!-- Attachment Exists - Display File Info -->
        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-start space-x-4">
                <!-- File Icon Based on Type -->
                <div class="flex-shrink-0">
                    {% with ext=attachment.filename|slice:"-4:"|lower %}
                    {% if ext == '.pdf' or attachment.filename|slice:"-4:"|lower == '.pdf' %}
                    <!-- PDF Icon - Red -->
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            <text x="7" y="17" font-size="6" fill="currentColor" font-weight="bold">PDF</text>
                        </svg>
                    </div>
                    {% elif '.doc' in attachment.filename|lower %}
                    <!-- DOC/DOCX Icon - Blue -->
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    {% elif '.xls' in attachment.filename|lower %}
                    <!-- XLS/XLSX Icon - Green -->
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    {% elif '.png' in attachment.filename|lower or '.jpg' in attachment.filename|lower or '.jpeg' in attachment.filename|lower %}
                    <!-- Image Icon - Purple -->
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    {% elif '.txt' in attachment.filename|lower %}
                    <!-- TXT Icon - Gray -->
                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                        <svg class="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    {% else %}
                    <!-- Default File Icon - Gray -->
                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                        <svg class="w-7 h-7 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    {% endif %}
                    {% endwith %}
                </div>

                <!-- File Details -->
                <div class="flex-1 min-w-0">
                    <!-- Filename (truncated if too long) -->
                    <p class="text-sm font-medium text-gray-900 truncate" title="{{ attachment.filename }}">
                        {{ attachment.filename|truncatechars:40 }}
                    </p>
                    
                    <!-- File Size -->
                    <p class="text-sm text-gray-500 mt-1">
                        {% if attachment.file_size >= 1048576 %}
                            {{ attachment.file_size|floatformat:0|divisibleby:1048576 }}{% widthratio attachment.file_size 1048576 1 %} MB
                        {% elif attachment.file_size >= 1024 %}
                            {% widthratio attachment.file_size 1024 1 %} KB
                        {% else %}
                            {{ attachment.file_size }} bytes
                        {% endif %}
                    </p>
                    
                    <!-- Upload Info -->
                    <p class="text-xs text-gray-400 mt-1">
                        Uploaded by {{ attachment.uploaded_by.get_full_name|default:attachment.uploaded_by.email }}
                        on {{ attachment.uploaded_at|date:"M d, Y" }} at {{ attachment.uploaded_at|time:"g:i A" }}
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="flex-shrink-0 flex flex-col space-y-2">
                    <!-- Download Button (always visible if attachment exists) -->
                    <a href="{% url 'tasks:download_attachment' task.pk %}" 
                       class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-150">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download
                    </a>
                    
                    {% if can_attachment %}
                    <!-- Replace Button (only if user can add attachments) -->
                    <label class="inline-flex items-center px-3 py-1.5 border border-indigo-300 shadow-sm text-xs font-medium rounded text-indigo-700 bg-indigo-50 hover:bg-indigo-100 cursor-pointer focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 transition-colors duration-150">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Replace
                        <form method="post" 
                              action="{% url 'tasks:upload_attachment' task.pk %}"
                              hx-post="{% url 'tasks:upload_attachment' task.pk %}"
                              hx-target="#attachment-section"
                              hx-swap="outerHTML"
                              hx-encoding="multipart/form-data"
                              hx-indicator="#attachment-loading"
                              class="hidden"
                              id="replace-attachment-form">
                            {% csrf_token %}
                            <input type="file" 
                                   name="file" 
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.txt"
                                   onchange="this.form.requestSubmit();"
                                   class="hidden">
                        </form>
                        <input type="file" 
                               name="file" 
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.txt"
                               form="replace-attachment-form"
                               onchange="document.getElementById('replace-attachment-form').requestSubmit();"
                               class="hidden">
                    </label>
                    {% endif %}
                    
                    {% if can_remove %}
                    <!-- Remove Button (only if user can remove) -->
                    <button type="button"
                            hx-post="{% url 'tasks:remove_attachment' task.pk %}"
                            hx-target="#attachment-section"
                            hx-swap="outerHTML"
                            hx-confirm="Are you sure you want to remove this attachment? This action cannot be undone."
                            hx-indicator="#attachment-loading"
                            class="inline-flex items-center px-3 py-1.5 border border-red-300 shadow-sm text-xs font-medium rounded text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-150">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Remove
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="attachment-loading" class="htmx-indicator mt-3 flex items-center justify-center">
            <svg class="animate-spin h-5 w-5 text-indigo-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm text-gray-600">Processing...</span>
        </div>

        {% elif can_attachment %}
        <!-- No Attachment - Show Upload Form -->
        <form method="post" 
              action="{% url 'tasks:upload_attachment' task.pk %}"
              hx-post="{% url 'tasks:upload_attachment' task.pk %}"
              hx-target="#attachment-section"
              hx-swap="outerHTML"
              hx-encoding="multipart/form-data"
              hx-indicator="#attachment-loading"
              enctype="multipart/form-data"
              class="space-y-4"
              id="upload-attachment-form">
            {% csrf_token %}
            
            <!-- File Input with Drag-Drop Styling -->
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors duration-150">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                
                <div class="mt-4">
                    <label for="file-upload" class="cursor-pointer">
                        <span class="mt-2 block text-sm font-medium text-indigo-600 hover:text-indigo-500">
                            Choose a file
                        </span>
                        <input id="file-upload" 
                               name="file" 
                               type="file" 
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.txt"
                               class="sr-only"
                               onchange="updateFileName(this); this.form.requestSubmit();">
                    </label>
                    <p class="mt-1 text-xs text-gray-500" id="file-name-display">
                        or drag and drop
                    </p>
                </div>
                
                <!-- Allowed Types & Size Limit -->
                <p class="mt-3 text-xs text-gray-400">
                    PDF, DOC, DOCX, XLS, XLSX, PNG, JPG, JPEG, TXT
                </p>
                <p class="text-xs text-amber-600 font-medium">
                    Maximum file size: 2 MB
                </p>
            </div>
            
            <!-- Loading Indicator -->
            <div id="attachment-loading" class="htmx-indicator flex items-center justify-center">
                <svg class="animate-spin h-5 w-5 text-indigo-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm text-gray-600">Uploading...</span>
            </div>
        </form>

        <script>
            function updateFileName(input) {
                const display = document.getElementById('file-name-display');
                if (input.files && input.files[0]) {
                    display.textContent = input.files[0].name;
                    display.classList.add('text-indigo-600', 'font-medium');
                    display.classList.remove('text-gray-500');
                }
            }
        </script>

        {% else %}
        <!-- No Attachment and User Cannot Upload -->
        <div class="text-center py-6">
            <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
            </svg>
            <p class="mt-2 text-sm text-gray-500 italic">No attachment.</p>
            
            {% if task.status == 'cancelled' %}
            <p class="mt-1 text-xs text-gray-400">
                Attachments cannot be added to cancelled tasks.
            </p>
            {% elif task.status == 'verified' %}
            <p class="mt-1 text-xs text-gray-400">
                Attachments cannot be added to verified tasks.
            </p>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- Error Message Container (for HTMX error responses) -->
        <div id="attachment-error" class="mt-3"></div>
    </div>
</div>