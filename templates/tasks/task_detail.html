{% extends 'base.html' %}
{% load tz %}

{% block title %}{{ task.reference_number }} - Task Manager{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
        <div>
            <a href="{% url 'tasks:dashboard' %}" 
               class="inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700">
                <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Back to Dashboard
            </a>
            <h1 class="mt-2 text-2xl font-bold text-gray-900">{{ task.reference_number }}</h1>
        </div>
        
        <!-- Action buttons -->
        <div class="flex space-x-3">
            {% if can_edit %}
            <a href="{% url 'tasks:task_edit' task.pk %}" 
               class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit
            </a>
            {% endif %}
            {% if can_reassign %}
            <a href="{% url 'tasks:task_reassign' task.pk %}" 
               class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                </svg>
                Reassign
            </a>
            {% endif %}
            {% if can_cancel %}
            <a href="{% url 'tasks:task_cancel' task.pk %}" 
               class="inline-flex items-center px-3 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Cancel
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content (2 columns) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Task Details Card -->
            <div class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h2 class="text-lg font-medium text-gray-900">{{ task.title }}</h2>
                    
                    {% if task.description %}
                    <div class="mt-4 text-sm text-gray-600 whitespace-pre-wrap">{{ task.description }}</div>
                    {% else %}
                    <p class="mt-4 text-sm text-gray-400 italic">No description provided.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Status change -->
            {% if can_change_status and status_form.fields.new_status.choices %}
            <div class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Update Status</h3>
                    <form method="post" action="{% url 'tasks:task_status_change' task.pk %}" class="flex items-center space-x-4">
                        {% csrf_token %}
                        {{ status_form.new_status }}
                        <button type="submit" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                            Update
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Attachment Section (Phase 7B: Using new partial) -->
            {% include 'tasks/partials/attachment_section.html' with task=task attachment=attachment attachment_form=attachment_form can_attachment=can_attachment can_remove=can_remove %}

            <!-- Comments Section (using partial from Phase 7A) -->
            {% include 'tasks/partials/comments_section.html' with task=task comments=comments comment_form=comment_form can_comment=can_comment %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Task info -->
            <div class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Details</h3>
                    <dl class="space-y-4">
                        <!-- Status -->
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Status</dt>
                            <dd class="mt-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if task.status == 'pending' %}bg-yellow-100 text-yellow-800
                                    {% elif task.status == 'in_progress' %}bg-blue-100 text-blue-800
                                    {% elif task.status == 'completed' %}bg-green-100 text-green-800
                                    {% elif task.status == 'verified' %}bg-green-200 text-green-900
                                    {% elif task.status == 'cancelled' %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ task.get_status_display }}
                                </span>
                                {% if task.is_overdue %}
                                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    OVERDUE
                                </span>
                                {% endif %}
                                {% if task.is_escalated %}
                                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-600 text-white">
                                    ESCALATED
                                </span>
                                {% endif %}
                            </dd>
                        </div>

                        <!-- Priority -->
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Priority</dt>
                            <dd class="mt-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if task.priority == 'low' %}bg-gray-100 text-gray-800
                                    {% elif task.priority == 'medium' %}bg-blue-100 text-blue-800
                                    {% elif task.priority == 'high' %}bg-amber-100 text-amber-800
                                    {% elif task.priority == 'critical' %}bg-red-100 text-red-800{% endif %}">
                                    {{ task.get_priority_display }}
                                </span>
                            </dd>
                        </div>

                        <!-- Task Type -->
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Type</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {{ task.get_task_type_display }}
                            </dd>
                        </div>

                        <!-- Deadline -->
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Deadline</dt>
                            <dd class="mt-1 text-sm {% if task.is_overdue %}text-red-600 font-medium{% else %}text-gray-900{% endif %}">
                                {% if task.deadline %}
                                    {{ task.deadline|timezone:request.user.timezone|date:"M d, Y" }} at {{ task.deadline|timezone:request.user.timezone|time:"g:i A" }}
                                    {% if task.is_overdue %}
                                    <span class="block text-xs text-red-500">(Overdue)</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400">No deadline set</span>
                                {% endif %}
                            </dd>
                        </div>

                        <!-- Department -->
                        {% if task.department %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Department</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ task.department.name }}</dd>
                        </div>
                        {% endif %}

                        <!-- Assignee -->
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Assignee</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {{ task.assignee.get_full_name|default:task.assignee.email }}
                                {% if task.assignee.department %}
                                <span class="text-gray-500">({{ task.assignee.department.name }})</span>
                                {% endif %}
                            </dd>
                        </div>

                        <!-- Creator -->
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Created by</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {{ task.created_by.get_full_name|default:task.created_by.email }}
                            </dd>
                        </div>

                        <!-- Created At -->
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Created</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {{ task.created_at|timezone:request.user.timezone|date:"M d, Y" }} at {{ task.created_at|timezone:request.user.timezone|time:"g:i A" }}
                            </dd>
                        </div>

                        <!-- Last Updated -->
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Last Updated</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {{ task.updated_at|timezone:request.user.timezone|date:"M d, Y" }} at {{ task.updated_at|timezone:request.user.timezone|time:"g:i A" }}
                            </dd>
                        </div>

                        <!-- Cancelled Info (if applicable) -->
                        {% if task.status == 'cancelled' and task.cancelled_by %}
                        <div class="border-t border-gray-200 pt-4">
                            <dt class="text-sm font-medium text-red-600">Cancelled by</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {{ task.cancelled_by.get_full_name|default:task.cancelled_by.email }}
                            </dd>
                            {% if task.cancellation_reason %}
                            <dt class="mt-2 text-sm font-medium text-red-600">Reason</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ task.cancellation_reason }}</dd>
                            {% endif %}
                        </div>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Activity</h3>
                    
                    {% if activities %}
                    <div class="flow-root">
                        <ul class="-mb-8">
                            {% for activity in activities %}
                            <li>
                                <div class="relative pb-8">
                                    {% if not forloop.last %}
                                    <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                                    {% endif %}
                                    <div class="relative flex space-x-3">
                                        <div>
                                            <span class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center ring-8 ring-white">
                                                {% if activity.action_type == 'created' %}
                                                <svg class="h-4 w-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                                </svg>
                                                {% elif activity.action_type == 'commented' %}
                                                <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                </svg>
                                                {% elif 'attachment' in activity.action_type %}
                                                <svg class="h-4 w-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                                                </svg>
                                                {% elif activity.action_type == 'status_changed' %}
                                                <svg class="h-4 w-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                                </svg>
                                                {% elif activity.action_type == 'cancelled' %}
                                                <svg class="h-4 w-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                                {% else %}
                                                <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1 pt-1.5">
                                            <p class="text-sm text-gray-500">
                                                <span class="font-medium text-gray-900">{{ activity.user.get_full_name|default:activity.user.email }}</span>
                                                <span class="text-xs text-gray-400 ml-2">{{ activity.created_at|timezone:request.user.timezone|date:"M d, g:i A" }}</span>
                                            </p>
                                            <p class="mt-0.5 text-sm text-gray-600">{{ activity.description }}</p>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500 italic">No activity recorded.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}